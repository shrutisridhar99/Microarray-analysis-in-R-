

# Read the data into R
data = as.matrix(read.table (text = "data_GEO.csv, row.names = 1, header = T))

dim(data)
head(data) 
tail(data) 


hist(data, col = "gray", main="data_GEO - Histogram")

Log2 transformation 
datalog = log2(data)

# Check the behavior of the data after log-transformation
hist(data2, col = "gray", main="data_GEO (log2) - Histogram")

# Boxplot
boxplot(datalog, col=c("darkblue", "darkblue", "darkblue",
	"darkred", "darkred", "darkred"),
	main="data_GEO - boxplots", las=2)

Hierarchical clustering of the "samples" 
hiclus = hclust(as.dist(1-cor(datalog)))
plot(hiclus, main="data_GEO - Hierarchical Clustering")

#######################################
# Differential expression (DE) analysis
#######################################

# Separate the two conditions into two smaller data frames
wildtype = data2[,1:3]
knockout = data2[,4:6]

# Compute the means of the samples of each condition
wt.mean = apply(wt, 1, mean)
ko.mean = apply(ko, 1, mean)

head(wt.mean)

head(ko.mean)


# Scatter plot
plot(ko.mean ~ wt.mean, xlab = "WT", ylab = "KO",
	main = "data_GEO - Scatter", xlim = c(0, limit), ylim = c(0, limit))
# Diagonal line
abline(0, 1, col = "red")

# Compute fold-change (biological significance)
# Difference between the means of the conditions
fold = wildtype.mean - knockout.mean

# fold difference
hist(fold, col = "gray")

# Compute statistical significance (using t-test)
pvalue = NULL 
tstat = NULL 

for(i in 1 : nrow(data)) { # For each gene : 
	x = wildtypet[i,] 
	y = knockout[i,] 
	
	# Compute t-test between the two conditions
	t = t.test(x, y)
	
	# Put the current p-value in the pvalues list
	pvalue[i] = t$p.value
	# Put the current t-statistic in the tstats list
	tstat[i] = t$statistic
}

head(pvalue)

# p-values (-log10)
hist(-log10(pvalue), col = "darkgreen")

# Volcano: put the biological significance (fold-change)
# and statistical significance (p-value) in one plot
plot(fold, -log10(pvalue), main = "data_GEO - Volcano")

fold_cutoff = 2
pvalue_cutoff = 0.01
abline(v = fold_cutoff, col = "blue", lwd = 3)
abline(v = -fold_cutoff, col = "red", lwd = 3)
abline(h = -log10(pvalue_cutoff), col = "green", lwd = 3)


filter_by_fold = abs(fold) >= fold_cutoff
dim(data2[filter_by_fold, ])

# P-value filter 
filter_by_pvalue = pvalue <= pvalue_cutoff
dim(data2[filter_by_pvalue, ])

# Combined filter (both biological and statistical)
filter_combined = filter_by_fold & filter_by_pvalue

filtered = data2[filter_combined,]
dim(filtered)

head(filtered)


# Let's generate the volcano plot again,
# highlighting the significantly differential expressed genes
plot(fold, -log10(pvalue), main = "GSE5583 - Volcano #2")
points (fold[filter_combined], -log10(pvalue[filter_combined]),
	pch = 16, col = "red")

# Highlighting up-regulated in red and down-regulated in blue
plot(fold, -log10(pvalue), main = "GSE5583 - Volcano #3")
points (fold[filter_combined & fold < 0],
	-log10(pvalue[filter_combined & fold < 0]),
	pch = 16, col = "red")
points (fold[filter_combined & fold > 0],
	-log10(pvalue[filter_combined & fold > 0]),
	pch = 16, col = "blue")


# Cluster the rows (genes) & columns (samples) by correlation
rowv = as.dendrogram(hclust(as.dist(1-cor(t(filtered)))))
colv = as.dendrogram(hclust(as.dist(1-cor(filtered))))

# Generate a heatmap
heatmap(filtered, Rowv=rowv, Colv=colv, cexCol=0.7)

# install.packages("gplots")		
# install.packages("RColorBrewer")	

library(gplots)

# Enhanced heatmap
heatmap.2(filtered, Rowv=rowv, Colv=colv, cexCol=0.7,
	col = rev(redblue(256)), scale = "row")

# Save the heatmap 
pdf ("data_GEO_Heatmap.pdf")
heatmap.2(filtered, Rowv=rowv, Colv=colv, cexCol=0.7,
	col = rev(redblue(256)), scale = "row")
dev.off()

# Save the DE genes to a text file
write.table (filtered, "data_GEO.txt", sep = "\t",
	quote = FALSE)
